# Feature Pack: auth-core
# Core authentication UI (login, signup, forgot password, email verification)
# Also includes org dimensions (locations, divisions, departments, user assignments)

name: auth-core
title: Admin
description: Core authentication UI and organizational structure management

# Schema contributions (Drizzle tables)
# Projects import these into their schema
schema:
  source: src/schema/org-dimensions.ts
  exports:
    # Location types
    - locationTypes
    - LocationType
    - InsertLocationType
    - UpdateLocationType
    # Locations
    - locations
    - Location
    - InsertLocation
    - UpdateLocation
    # Divisions
    - divisions
    - Division
    - InsertDivision
    - UpdateDivision
    # Departments
    - departments
    - Department
    - InsertDepartment
    - UpdateDepartment
    # User Org Assignments
    - userOrgAssignments
    - UserOrgAssignment
    - InsertUserOrgAssignment
    - UpdateUserOrgAssignment
    # Entity Scopes (multi-LDD)
    - orgEntityScopes
    - OrgEntityScope
    - InsertOrgEntityScope
    - UpdateOrgEntityScope
    # Utility types
    - OrgDimensionKind
    - OrgScope
    - OwnershipScope
    # Default data
    - DEFAULT_LOCATION_TYPES

# Route definitions
routes:
  - path: /login
    page: Login
  - path: /signup
    page: Signup
  - path: /forgot-password
    page: ForgotPassword
  - path: /reset-password
    page: ResetPassword
  - path: /verify-email
    page: VerifyEmail
  - path: /email-not-verified
    page: EmailNotVerified
  - path: /magic-link
    page: MagicLink
  - path: /invites/accept
    page: InviteAccept
    featureFlag: auth.allow_invited

  # Admin routes (merged into auth-core)
  - path: /admin
    page: Dashboard
    roles: [admin]
    default_roles_allow: [admin]
  - path: /admin/users
    page: Users
    roles: [admin]
    default_roles_allow: [admin]
  - path: /admin/users/[email]
    page: UserDetail
    roles: [admin]
    default_roles_allow: [admin]
  - path: /admin/sessions
    page: Sessions
    roles: [admin]
    default_roles_allow: [admin]
  - path: /admin/audit-log
    page: AuditLog
    roles: [admin]
    default_roles_allow: [admin]
    featureFlag: auth.audit_log
  - path: /admin/invites
    page: Invites
    roles: [admin]
    default_roles_allow: [admin]
    featureFlag: auth.allow_invited
  - path: /admin/groups
    page: Groups
    roles: [admin]
    default_roles_allow: [admin]
    featureFlag: auth.user_groups_enabled
  - path: /admin/security-groups
    page: SecurityGroupsList
    roles: [admin]
    default_roles_allow: [admin]
  - path: /admin/security-groups/[id]
    page: SecurityGroupDetail
    roles: [admin]
    default_roles_allow: [admin]

  # Org Structure routes
  - path: /admin/org/locations
    page: Locations
    roles: [admin]
    default_roles_allow: [admin]
    authz: { entity: locations, verb: read, require_mode: any }
  - path: /admin/org/divisions
    page: Divisions
    roles: [admin]
    default_roles_allow: [admin]
    authz: { entity: divisions, verb: read, require_mode: any }
  - path: /admin/org/departments
    page: Departments
    roles: [admin]
    default_roles_allow: [admin]
    authz: { entity: departments, verb: read, require_mode: any }
  - path: /admin/org/assignments
    page: OrgAssignments
    roles: [admin]
    default_roles_allow: [admin]
    authz: { entity: assignments, verb: read }

# Navigation contributions
# Login/signup are hidden from nav - users access via auth redirects
nav:
  - id: login
    label: Login
    path: /login
    icon: log-in
    showWhen: unauthenticated
    hideFromNav: true  # Don't show in sidebar - accessed via redirects
  - id: signup
    label: Sign Up
    path: /signup
    icon: user-plus
    showWhen: unauthenticated
    hideFromNav: true  # Don't show in sidebar - accessed via redirects

  - id: admin
    label: Admin
    icon: ShieldCheck
    group: system  # System/admin tools
    roles: [admin]
    showWhen: authenticated
    weight: 1000  # Admin at bottom of nav (higher weight = lower position)
    children:
      - label: Dashboard
        path: /admin
        icon: LayoutDashboard
        weight: 100  # First - admin landing page
      - label: Users
        path: /admin/users
        icon: Users
        weight: 110
      - label: Groups
        path: /admin/groups
        icon: UsersRound
        featureFlag: auth.user_groups_enabled
        weight: 120
      - label: Sessions
        path: /admin/sessions
        icon: Key
        weight: 130
      - label: Security Groups
        path: /admin/security-groups
        icon: Lock
        weight: 140
      - label: Invites
        path: /admin/invites
        icon: Mail
        featureFlag: auth.allow_invited
        weight: 150
      - label: Audit Log
        path: /admin/audit-log
        icon: FileText
        featureFlag: auth.audit_log
        weight: 160
      - label: LDD
        icon: Building
        weight: 170
        children:
          - label: Locations
            path: /admin/org/locations
            icon: MapPin
            weight: 100
          - label: Divisions
            path: /admin/org/divisions
            icon: Building2
            weight: 110
          - label: Departments
            path: /admin/org/departments
            icon: Network
            weight: 120
          - label: Org Assignments
            path: /admin/org/assignments
            icon: UserCog
            weight: 130

# API routes - org dimensions management
api:
  routes:
    # Location Types
    - path: /api/org/location-types
      methods: [GET, POST]
      handler: "@hit/feature-pack-auth-core/server/api/location-types"
      description: "List location types (GET) or create location type (POST)"

    # Locations
    - path: /api/org/locations
      methods: [GET, POST]
      handler: "@hit/feature-pack-auth-core/server/api/locations"
      description: "List locations (GET) or create location (POST)"
    - path: /api/org/locations/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-auth-core/server/api/locations-id"
      description: "Get, update, or delete a specific location"

    # Divisions
    - path: /api/org/divisions
      methods: [GET, POST]
      handler: "@hit/feature-pack-auth-core/server/api/divisions"
      description: "List divisions (GET) or create division (POST)"
    - path: /api/org/divisions/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-auth-core/server/api/divisions-id"
      description: "Get, update, or delete a specific division"

    # Departments
    - path: /api/org/departments
      methods: [GET, POST]
      handler: "@hit/feature-pack-auth-core/server/api/departments"
      description: "List departments (GET) or create department (POST)"
    - path: /api/org/departments/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-auth-core/server/api/departments-id"
      description: "Get, update, or delete a specific department"

    # User Org Assignments
    - path: /api/org/assignments
      methods: [GET, POST]
      handler: "@hit/feature-pack-auth-core/server/api/assignments"
      description: "List user org assignments (GET) or create assignment (POST)"
    - path: /api/org/assignments/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-auth-core/server/api/assignments-id"
      description: "Get, update, or delete a specific assignment"

    # Org Scope
    - path: /api/org/me/scope
      methods: [GET]
      handler: "@hit/feature-pack-auth-core/server/api/me-scope"
      description: "Get current user's org scope (divisions, departments, locations)"
    - path: /api/org/users/[userKey]/scope
      methods: [GET]
      handler: "@hit/feature-pack-auth-core/server/api/users-scope"
      description: "Get org scope for a specific user (admin only)"

# Dependencies
requires:
  modules: [auth]

# Configurable options
config:
  schema:
    login_redirect:
      type: string
      default: "/"
      description: Where to redirect after login
    signup_redirect:
      type: string
      default: "/"
      description: Where to redirect after signup
    show_privacy_checkbox:
      type: boolean
      default: false
      description: Show privacy policy checkbox on signup
    password_min_length:
      type: number
      default: 8
      description: Minimum password length
    branding:
      type: object
      default: {}
      description: Branding options (logo_url, app_name, tagline)

# ─────────────────────────────────────────────────────────────────────────────
# METRICS - Feature pack metric definitions
# ─────────────────────────────────────────────────────────────────────────────
metrics:
  definitions:
    - key: fp.auth-core.user_count
      label: User Count
      unit: count
      icon: Users
      icon_color: "#16a34a"
      rollup_strategy: last
      entity_kinds: [user]
      time_kind: realtime
      # Default: On for admin templates, Off for user templates.
      default_roles_allow: [admin]
    - key: fp.auth-core.users_all
      label: Users (All)
      unit: users
      rollup_strategy: last
      entity_kinds: [user]
      time_kind: none
      description: "User-list metric: all users in the system."
      # Default: On for admin templates, Off for user templates.
      default_roles_allow: [admin]
    - key: fp.auth-core.users_admins
      label: Users (Admins)
      unit: users
      rollup_strategy: last
      entity_kinds: [user]
      time_kind: none
      description: "User-list metric: users whose role is admin."
      # Default: On for admin templates, Off for user templates.
      default_roles_allow: [admin]
    - key: fp.auth-core.users_unverified
      label: Users (Unverified)
      unit: users
      rollup_strategy: last
      entity_kinds: [user]
      time_kind: none
      description: "User-list metric: users who have not verified their email."
      # Default: On for admin templates, Off for user templates.
      default_roles_allow: [admin]

# ─────────────────────────────────────────────────────────────────────────────
# PERMISSIONS - Action definitions (for admin-core permissions UI + runtime checks)
# ─────────────────────────────────────────────────────────────────────────────
permissions:
  actions:
    - key: auth-core.admin.access
      label: Auth Core Admin Access
      description: "Access auth-core admin-only helper endpoints (e.g., directory user list, org scope lookup, location type management)."
      default_enabled: false

    # Scope Policy Tree: auth-core (global) -> entity overrides.
    #
    # Scope modes:
    # - none: deny all access for this verb/entity (hide pages + block APIs)
    # - any: ignore scope (read everything) - admin can see/edit all org dimensions
    # - own: deny access (org dimensions don't have ownership fields)
    # - ldd: deny access (org dimensions don't have LDD fields)
    #
    # These are mutually exclusive per node; the Security Groups UI renders them as dropdowns.
    # Note: Org dimensions (locations, divisions, departments, assignments) are admin-only
    # system configuration. They don't have ownership or LDD fields, so `own` and `ldd`
    # modes deny access (only `any` mode allows access).
    - key: auth-core.read.scope.none
      label: "Auth-Core Read Scope = None"
      description: "Deny all auth-core read access."
      default_enabled: false
    - key: auth-core.read.scope.any
      label: "Auth-Core Read Scope = Any"
      description: "Read all auth-core entities regardless of scope."
      default_enabled: false
    - key: auth-core.read.scope.own
      label: "Auth-Core Read Scope = Own"
      description: "Read only auth-core entities you own (not applicable for org dimensions)."
      default_enabled: false

    - key: auth-core.write.scope.none
      label: "Auth-Core Write Scope = None"
      description: "Deny all auth-core write access."
      default_enabled: false
    - key: auth-core.write.scope.any
      label: "Auth-Core Write Scope = Any"
      description: "Edit auth-core entities regardless of scope."
      default_enabled: false
    - key: auth-core.write.scope.own
      label: "Auth-Core Write Scope = Own"
      description: "Edit only auth-core entities you own (not applicable for org dimensions)."
      default_enabled: false

    - key: auth-core.delete.scope.none
      label: "Auth-Core Delete Scope = None"
      description: "Deny all auth-core delete access."
      default_enabled: false
    - key: auth-core.delete.scope.any
      label: "Auth-Core Delete Scope = Any"
      description: "Delete auth-core entities regardless of scope."
      default_enabled: false
    - key: auth-core.delete.scope.own
      label: "Auth-Core Delete Scope = Own"
      description: "Delete only auth-core entities you own (not applicable for org dimensions)."
      default_enabled: false

    # Locations override (optional): if set, overrides auth-core.read.scope.* for locations only.
    - key: auth-core.locations.read.scope.none
      label: "Auth-Core Locations Read Scope = None"
      description: "Deny all location read access."
      default_enabled: false
    - key: auth-core.locations.read.scope.any
      label: "Auth-Core Locations Read Scope = Any"
      description: "Read locations regardless of scope."
      default_enabled: false

    # NOTE: org dimensions use explicit create/update/delete actions; no write/delete scope modes.

    - key: auth-core.locations.create
      label: Create Location
      description: "Create a new location."
      default_enabled: false
    - key: auth-core.locations.update
      label: Update Location
      description: "Update an existing location."
      default_enabled: false
    - key: auth-core.locations.delete
      label: Delete Location
      description: "Delete a location."
      default_enabled: false

    # Divisions override
    - key: auth-core.divisions.read.scope.none
      label: "Auth-Core Divisions Read Scope = None"
      description: "Deny all division read access."
      default_enabled: false
    - key: auth-core.divisions.read.scope.any
      label: "Auth-Core Divisions Read Scope = Any"
      description: "Read divisions regardless of scope."
      default_enabled: false

    # NOTE: org dimensions use explicit create/update/delete actions; no write/delete scope modes.

    - key: auth-core.divisions.create
      label: Create Division
      description: "Create a new division."
      default_enabled: false
    - key: auth-core.divisions.update
      label: Update Division
      description: "Update an existing division."
      default_enabled: false
    - key: auth-core.divisions.delete
      label: Delete Division
      description: "Delete a division."
      default_enabled: false

    # Departments override
    - key: auth-core.departments.read.scope.none
      label: "Auth-Core Departments Read Scope = None"
      description: "Deny all department read access."
      default_enabled: false
    - key: auth-core.departments.read.scope.any
      label: "Auth-Core Departments Read Scope = Any"
      description: "Read departments regardless of scope."
      default_enabled: false

    # NOTE: org dimensions use explicit create/update/delete actions; no write/delete scope modes.

    - key: auth-core.departments.create
      label: Create Department
      description: "Create a new department."
      default_enabled: false
    - key: auth-core.departments.update
      label: Update Department
      description: "Update an existing department."
      default_enabled: false
    - key: auth-core.departments.delete
      label: Delete Department
      description: "Delete a department."
      default_enabled: false

    # Assignments override
    - key: auth-core.assignments.read.scope.none
      label: "Auth-Core Assignments Read Scope = None"
      description: "Deny all assignment read access."
      default_enabled: false
    - key: auth-core.assignments.read.scope.any
      label: "Auth-Core Assignments Read Scope = Any"
      description: "Read assignments regardless of scope."
      default_enabled: false
    - key: auth-core.assignments.read.scope.own
      label: "Auth-Core Assignments Read Scope = Own"
      description: "Read only assignments you own (your own assignment)."
      default_enabled: false
    - key: auth-core.assignments.read.scope.ldd
      label: "Auth-Core Assignments Read Scope = LDD"
      description: "Read assignments you own, or that match your L/D/D scope."
      default_enabled: false

    - key: auth-core.assignments.write.scope.none
      label: "Auth-Core Assignments Write Scope = None"
      description: "Deny all assignment write access."
      default_enabled: false
    - key: auth-core.assignments.write.scope.any
      label: "Auth-Core Assignments Write Scope = Any"
      description: "Edit assignments regardless of scope."
      default_enabled: false
    - key: auth-core.assignments.write.scope.own
      label: "Auth-Core Assignments Write Scope = Own"
      description: "Edit only assignments you own (your own assignment)."
      default_enabled: false
    - key: auth-core.assignments.write.scope.ldd
      label: "Auth-Core Assignments Write Scope = LDD"
      description: "Edit assignments you own, or that match your L/D/D scope."
      default_enabled: false

    - key: auth-core.assignments.delete.scope.none
      label: "Auth-Core Assignments Delete Scope = None"
      description: "Deny all assignment delete access."
      default_enabled: false
    - key: auth-core.assignments.delete.scope.any
      label: "Auth-Core Assignments Delete Scope = Any"
      description: "Delete assignments regardless of scope."
      default_enabled: false
    - key: auth-core.assignments.delete.scope.own
      label: "Auth-Core Assignments Delete Scope = Own"
      description: "Delete only assignments you own (your own assignment)."
      default_enabled: false
    - key: auth-core.assignments.delete.scope.ldd
      label: "Auth-Core Assignments Delete Scope = LDD"
      description: "Delete assignments you own, or that match your L/D/D scope."
      default_enabled: false

    - key: auth-core.assignments.create
      label: Create Assignment
      description: "Create a new user org assignment."
      default_enabled: false
