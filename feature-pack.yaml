# Feature Pack: auth-core
# Core authentication UI (login, signup, forgot password, email verification)
# Also includes org dimensions (locations, divisions, departments, user assignments)

name: auth-core
title: Admin
description: Core authentication UI and organizational structure management

# Schema contributions (Drizzle tables)
# Projects import these into their schema
schema:
  source: src/schema/org-dimensions.ts
  exports:
    # Location types
    - locationTypes
    - LocationType
    - InsertLocationType
    - UpdateLocationType
    # Locations
    - locations
    - Location
    - InsertLocation
    - UpdateLocation
    # Divisions
    - divisions
    - Division
    - InsertDivision
    - UpdateDivision
    # Departments
    - departments
    - Department
    - InsertDepartment
    - UpdateDepartment
    # User Org Assignments
    - userOrgAssignments
    - UserOrgAssignment
    - InsertUserOrgAssignment
    - UpdateUserOrgAssignment
    # Entity Scopes (multi-LDD)
    - orgEntityScopes
    - OrgEntityScope
    - InsertOrgEntityScope
    - UpdateOrgEntityScope
    # Utility types
    - OrgDimensionKind
    - OrgScope
    - OwnershipScope
    # Default data
    - DEFAULT_LOCATION_TYPES

# Route definitions
routes:
  - path: /login
    page: Login
  - path: /signup
    page: Signup
  - path: /forgot-password
    page: ForgotPassword
  - path: /reset-password
    page: ResetPassword
  - path: /verify-email
    page: VerifyEmail
  - path: /email-not-verified
    page: EmailNotVerified
  - path: /magic-link
    page: MagicLink
  - path: /invites/accept
    page: InviteAccept
    featureFlag: auth.allow_invited

  # Admin routes (merged into auth-core)
  - path: /admin
    page: Dashboard
    roles: [admin]
  - path: /admin/users
    page: Users
    roles: [admin]
  - path: /admin/users/[email]
    page: UserDetail
    roles: [admin]
  - path: /admin/sessions
    page: Sessions
    roles: [admin]
  - path: /admin/audit-log
    page: AuditLog
    roles: [admin]
    featureFlag: auth.audit_log
  - path: /admin/invites
    page: Invites
    roles: [admin]
    featureFlag: auth.allow_invited
  - path: /admin/groups
    page: Groups
    roles: [admin]
    featureFlag: auth.user_groups_enabled
  - path: /admin/security-groups
    page: SecurityGroupsList
    roles: [admin]
  - path: /admin/security-groups/[id]
    page: SecurityGroupDetail
    roles: [admin]

  # Org Structure routes
  - path: /admin/org/locations
    page: Locations
    roles: [admin]
  - path: /admin/org/divisions
    page: Divisions
    roles: [admin]
  - path: /admin/org/departments
    page: Departments
    roles: [admin]
  - path: /admin/org/assignments
    page: OrgAssignments
    roles: [admin]

# Navigation contributions
# Login/signup are hidden from nav - users access via auth redirects
nav:
  - id: login
    label: Login
    path: /login
    icon: log-in
    showWhen: unauthenticated
    hideFromNav: true  # Don't show in sidebar - accessed via redirects
  - id: signup
    label: Sign Up
    path: /signup
    icon: user-plus
    showWhen: unauthenticated
    hideFromNav: true  # Don't show in sidebar - accessed via redirects

  - id: admin
    label: Admin
    icon: ShieldCheck
    group: system  # System/admin tools
    roles: [admin]
    showWhen: authenticated
    weight: 1000  # Admin at bottom of nav (higher weight = lower position)
    children:
      - label: Dashboard
        path: /admin
        icon: LayoutDashboard
        weight: 100  # First - admin landing page
      - label: Users
        path: /admin/users
        icon: Users
        weight: 110
      - label: Groups
        path: /admin/groups
        icon: UsersRound
        featureFlag: auth.user_groups_enabled
        weight: 120
      - label: Sessions
        path: /admin/sessions
        icon: Key
        weight: 130
      - label: Security Groups
        path: /admin/security-groups
        icon: Lock
        weight: 140
      - label: Invites
        path: /admin/invites
        icon: Mail
        featureFlag: auth.allow_invited
        weight: 150
      - label: Audit Log
        path: /admin/audit-log
        icon: FileText
        featureFlag: auth.audit_log
        weight: 160
      - label: LDD
        icon: Building
        weight: 170
        children:
          - label: Locations
            path: /admin/org/locations
            icon: MapPin
            weight: 100
          - label: Divisions
            path: /admin/org/divisions
            icon: Building2
            weight: 110
          - label: Departments
            path: /admin/org/departments
            icon: Network
            weight: 120
          - label: Org Assignments
            path: /admin/org/assignments
            icon: UserCog
            weight: 130

# API routes - org dimensions management
api:
  routes:
    # Location Types
    - path: /api/org/location-types
      methods: [GET, POST]
      handler: "@hit/feature-pack-auth-core/server/api/location-types"
      description: "List location types (GET) or create location type (POST)"

    # Locations
    - path: /api/org/locations
      methods: [GET, POST]
      handler: "@hit/feature-pack-auth-core/server/api/locations"
      description: "List locations (GET) or create location (POST)"
    - path: /api/org/locations/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-auth-core/server/api/locations-id"
      description: "Get, update, or delete a specific location"

    # Divisions
    - path: /api/org/divisions
      methods: [GET, POST]
      handler: "@hit/feature-pack-auth-core/server/api/divisions"
      description: "List divisions (GET) or create division (POST)"
    - path: /api/org/divisions/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-auth-core/server/api/divisions-id"
      description: "Get, update, or delete a specific division"

    # Departments
    - path: /api/org/departments
      methods: [GET, POST]
      handler: "@hit/feature-pack-auth-core/server/api/departments"
      description: "List departments (GET) or create department (POST)"
    - path: /api/org/departments/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-auth-core/server/api/departments-id"
      description: "Get, update, or delete a specific department"

    # User Org Assignments
    - path: /api/org/assignments
      methods: [GET, POST]
      handler: "@hit/feature-pack-auth-core/server/api/assignments"
      description: "List user org assignments (GET) or create assignment (POST)"
    - path: /api/org/assignments/[id]
      methods: [GET, PUT, DELETE]
      handler: "@hit/feature-pack-auth-core/server/api/assignments-id"
      description: "Get, update, or delete a specific assignment"

    # Org Scope
    - path: /api/org/me/scope
      methods: [GET]
      handler: "@hit/feature-pack-auth-core/server/api/me-scope"
      description: "Get current user's org scope (divisions, departments, locations)"
    - path: /api/org/users/[userKey]/scope
      methods: [GET]
      handler: "@hit/feature-pack-auth-core/server/api/users-scope"
      description: "Get org scope for a specific user (admin only)"

# Dependencies
requires:
  modules: [auth]

# Configurable options
config:
  schema:
    login_redirect:
      type: string
      default: "/"
      description: Where to redirect after login
    signup_redirect:
      type: string
      default: "/"
      description: Where to redirect after signup
    show_privacy_checkbox:
      type: boolean
      default: false
      description: Show privacy policy checkbox on signup
    password_min_length:
      type: number
      default: 8
      description: Minimum password length
    branding:
      type: object
      default: {}
      description: Branding options (logo_url, app_name, tagline)

# ─────────────────────────────────────────────────────────────────────────────
# METRICS - Feature pack metric definitions
# ─────────────────────────────────────────────────────────────────────────────
metrics:
  definitions:
    - key: fp.auth-core.user_count
      label: User Count
      unit: count
      icon: Users
      icon_color: "#16a34a"
      rollup_strategy: last
      entity_kinds: [user]
      time_kind: realtime
    - key: fp.auth-core.users_all
      label: Users (All)
      unit: users
      rollup_strategy: last
      entity_kinds: [user]
      time_kind: none
      description: "User-list metric: all users in the system."
    - key: fp.auth-core.users_admins
      label: Users (Admins)
      unit: users
      rollup_strategy: last
      entity_kinds: [user]
      time_kind: none
      description: "User-list metric: users whose role is admin."
    - key: fp.auth-core.users_unverified
      label: Users (Unverified)
      unit: users
      rollup_strategy: last
      entity_kinds: [user]
      time_kind: none
      description: "User-list metric: users who have not verified their email."
